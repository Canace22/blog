---
title: Webç«¯ç‰ˆæœ¬æ›´æ–°å¼¹çª—å®ç°
categories: web
description: è®°å½•è½®è¯¢ç®€å•å®ç°ç½‘é¡µæ›´æ–°Webç«¯å¼¹çª—æ–¹æ¡ˆï¼Œä¸»è¦å†…å®¹åŒ…æ‹¬:å¸¸ç”¨æ¶ˆæ¯æ¨é€æ–¹æ¡ˆä»‹ç»ã€ç½‘é¡µæ›´æ–°æ–¹æ³•æ¦‚è¿°ä»¥åŠåŸºäºè½®è¯¢çš„ç½‘é¡µæ›´æ–°å¼¹çª—å®ç°demoå±•ç¤º
author: Canace
toc: true
comments: true
date: 2025-02-28 15:06:04
---

## ä¸€ã€å¸¸ç”¨æ¶ˆæ¯æ¨é€æ–¹æ¡ˆæ¦‚è¿°

Web ç«¯å®ç°æ›´æ–°å¼¹çª—çš„æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼šè½®è¯¢ã€é•¿è½®è¯¢ã€WebSocketã€Server-Sent Eventsï¼ˆSSEï¼‰ä»¥åŠ Service Worker + Push APIï¼ˆPWA æ¨é€ï¼‰ï¼Œå‡ ç§æ–¹æ¡ˆå„æœ‰ä¼˜åŠ£ï¼Œä¸‹é¢åšä¸€ä¸ªç®€å•å¯¹æ¯”ã€‚

### 1. è½®è¯¢ï¼ˆPollingï¼‰

- **åŸç†**ï¼šWebç«¯å®šæ—¶å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦æœ‰æ›´æ–°ã€‚
- **å®ç°**ï¼šä½¿ç”¨ `setInterval` æˆ– `setTimeout` å®šæœŸå‘é€ HTTP è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æ›´æ–°çŠ¶æ€æˆ–æ•°æ®ã€‚
- **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ï¼Œå…¼å®¹æ€§å¥½ã€‚
- **ç¼ºç‚¹**ï¼šå»¶è¿Ÿé«˜ï¼ˆä¾èµ–è½®è¯¢é—´éš”ï¼‰ã€æµªè´¹å¸¦å®½ã€å¢åŠ æœåŠ¡å™¨å‹åŠ›ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šä½é¢‘æ›´æ–°æˆ–å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚

### 2. é•¿è½®è¯¢ï¼ˆLong Pollingï¼‰

- **åŸç†**ï¼šWebç«¯å‘èµ·è¯·æ±‚åï¼ŒæœåŠ¡å™¨ä¿æŒè¿æ¥ç›´åˆ°æœ‰æ•°æ®æˆ–è¶…æ—¶ï¼Œå†é‡æ–°å‘èµ·è¯·æ±‚ã€‚
- **å®ç°**ï¼šWebç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨æŒ‚èµ·ç›´åˆ°æœ‰æ•°æ®ï¼Œè¿”å›æ•°æ®åWebç«¯ç«‹å³å‘èµ·æ–°è¯·æ±‚ã€‚
- **ä¼˜ç‚¹**ï¼šæ¯”è½®è¯¢å®æ—¶æ€§æ›´é«˜ï¼Œå‡å°‘æ— æ•ˆè¯·æ±‚ã€‚
- **ç¼ºç‚¹**ï¼šæœåŠ¡å™¨éœ€å¤„ç†å¤§é‡æŒ‚èµ·è¿æ¥ï¼Œå¯èƒ½å¢åŠ èµ„æºæ¶ˆè€—ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šä¸­ç­‰å®æ—¶æ€§éœ€æ±‚ã€‚

### 3. WebSocket

- **åŸç†**ï¼šåŸºäº TCP çš„å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå»ºç«‹æŒä¹…è¿æ¥ååŒæ–¹å¯ä¸»åŠ¨æ¨é€æ¶ˆæ¯ã€‚
- **å®ç°**ï¼šWebç«¯é€šè¿‡ `new WebSocket(url)` å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç›‘å¬ WebSocket è¯·æ±‚å¹¶ç»´æŠ¤è¿æ¥æ± ï¼ŒWebç«¯é€šè¿‡ `onmessage` äº‹ä»¶æ¥æ”¶æ•°æ®ã€‚
- **ä¼˜ç‚¹**ï¼šå®æ—¶æ€§å¼ºã€ä½å»¶è¿Ÿã€èŠ‚çœå¸¦å®½ã€‚
- **ç¼ºç‚¹**ï¼šéœ€æœåŠ¡å™¨æ”¯æŒ WebSocket åè®®ï¼ˆå¦‚ Node.js çš„ `ws` åº“ï¼‰ï¼Œå¤æ‚åº¦è¾ƒé«˜ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šé«˜é¢‘åŒå‘é€šä¿¡ã€‚

### 4. Server-Sent Eventsï¼ˆSSEï¼‰

- **åŸç†**ï¼šåŸºäº HTTP çš„å•å‘é€šä¿¡ï¼ŒæœåŠ¡å™¨å¯ä¸»åŠ¨æ¨é€æ•°æ®åˆ°Webç«¯ã€‚
- **å®ç°**ï¼šWebç«¯é€šè¿‡ `EventSource` API è®¢é˜…æœåŠ¡å™¨äº‹ä»¶æµï¼ŒæœåŠ¡å™¨è¿”å› `Content-Type: text/event-stream` çš„å“åº”ï¼ŒæŒç»­å‘é€æ•°æ®ã€‚
- **ä¼˜ç‚¹**ï¼šç®€å•ï¼ˆä»…éœ€ HTTPï¼‰ã€è‡ªåŠ¨é‡è¿ã€è½»é‡çº§ã€‚
- **ç¼ºç‚¹**ï¼šä»…æ”¯æŒæ–‡æœ¬æ•°æ®ã€å•å‘é€šä¿¡ï¼ˆæœåŠ¡å™¨åˆ°Webç«¯ï¼‰ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šå•å‘å®æ—¶æ›´æ–°ã€‚

### 5. Service Worker + Push APIï¼ˆPWA æ¨é€ï¼‰

- **åŸç†**ï¼šé€šè¿‡æµè§ˆå™¨åå°æœåŠ¡ï¼ˆService Workerï¼‰æ¥æ”¶æœåŠ¡å™¨æ¨é€ï¼Œå³ä½¿é¡µé¢å…³é—­ä¹Ÿèƒ½æ˜¾ç¤ºé€šçŸ¥ã€‚
- **å®ç°**ï¼šWebç«¯æ³¨å†Œ Service Worker å¹¶è¯·æ±‚é€šçŸ¥æƒé™ï¼ŒæœåŠ¡å™¨é€šè¿‡ **Web Push Protocol** å‘é€åŠ å¯†æ¶ˆæ¯ï¼ˆéœ€ VAPID å¯†é’¥ï¼‰ï¼ŒWebç«¯Service Worker çš„ `push` äº‹ä»¶è§¦å‘é€šçŸ¥ã€‚
- **ä¼˜ç‚¹**ï¼šç¦»çº¿æ¨é€ã€ç±»ä¼¼åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚
- **ç¼ºç‚¹**ï¼šéœ€ HTTPSã€ç”¨æˆ·éœ€æˆæƒé€šçŸ¥æƒé™ã€å®ç°è¾ƒå¤æ‚ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šæ¸è¿›å¼ Web åº”ç”¨ï¼ˆPWAï¼‰çš„ç¦»çº¿é€šçŸ¥ï¼ˆå¦‚é‚®ä»¶æé†’ï¼‰ã€‚

é€šè¿‡ä»¥ä¸Šå„æ–¹æ¡ˆçš„å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å¯¹äºç®€å•ä½é¢‘çš„æ›´æ–°ï¼Œä½¿ç”¨è½®è¯¢æˆ–é•¿è½®è¯¢å³å¯ã€‚å®æ—¶æ€§è¦æ±‚é«˜ä¼˜å…ˆé€‰ WebSocketï¼ˆåŒå‘ï¼‰æˆ– SSEï¼ˆå•å‘ï¼‰ã€‚æœ‰ç¦»çº¿æ¨é€éœ€æ±‚å¯ä»¥ä½¿ç”¨ Service Worker + Push APIã€‚æˆ‘ä»¬è¦å®ç°çš„ç½‘é¡µç‰ˆæœ¬æ›´æ–°å¼¹çª—å±äºæ¯”è¾ƒç®€å•ä½é¢‘çš„æ›´æ–°ï¼Œå¯èƒ½ä¸€å‘¨æˆ–è€…æ›´é•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨è½®è¯¢æˆ–é•¿è½®è¯¢å°±å¤Ÿäº†ã€‚

é•¿è½®è¯¢éœ€è¦æœåŠ¡ç«¯æ”¯æŒï¼Œåˆ«äººæœªå¿…æœ‰ç©ºæ­ç†æˆ‘ä»¬ï¼Œä¹Ÿä¸è€ƒè™‘ã€‚å‰©æœ€åä¸€ä¸ªæ–¹æ¡ˆï¼Œè½®è¯¢ï¼Œé‚£ä¹ˆå¦‚ä½•åœ¨ä¸éœ€è¦æœåŠ¡ç«¯æ”¯æŒçš„æƒ…å†µä¸‹ï¼Œå®ç°è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå‰ç«¯è‡ªå·±å®šä¹‰ä¸€ä¸ª json æ–‡ä»¶ï¼Œæ¯æ¬¡è½®è¯¢éƒ½å»è¯·æ±‚è¿™ä»½æ–‡ä»¶ï¼Œåœ¨æ‰“åŒ…æ„å»ºé˜¶æ®µå»æ›´æ–°æ–‡ä»¶é‡Œé¢çš„ç‰ˆæœ¬ç›¸å…³å­—æ®µï¼Œè¿™æ ·éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬è¯·æ±‚åˆ°çš„æœ€æ–°ç‰ˆæœ¬å·å°±æ˜¯æœ€æ–°çš„äº†ã€‚

æ¶ˆæ¯æ¨é€çš„æ–¹æ¡ˆæˆ‘ä»¬æœ‰äº†ï¼Œæ¥ç€æ˜¯å¦‚ä½•å»æ›´æ–°ç½‘é¡µå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“æœ‰æ—¶å€™åˆ·æ–°ä¸€ä¸‹ï¼Œç½‘é¡µè¿˜æ˜¯æ—§çš„ï¼Œè¿™å°±æ¶‰åŠåˆ°æµè§ˆå™¨çš„ç¼“å­˜ç­–ç•¥äº†ã€‚

## äºŒã€ç½‘é¡µæ›´æ–°æ–¹æ³•æ¦‚è¿°

åœ¨æ—¥å¸¸å¼€å‘ä¸­æœ‰æ—¶å€™ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘çš„ä»£ç æ˜æ˜å·²ç»æ¨åˆ°æœåŠ¡å™¨ä¸Šéƒ¨ç½²å¥½äº†ï¼Œåˆ·æ–°ç•Œé¢ï¼Œè¿˜æ˜¯æ—§çš„ï¼Œæœ‰æ—¶å†åˆ·æ–°ä¸€ä¸‹å°±æ˜¯æ–°çš„é¡µé¢äº†ï¼Œä½†æ˜¯æœ‰æ—¶åˆ·æ–°å¾ˆå¤šæ¬¡ä¹Ÿè¿˜æ˜¯æ—§çš„ç•Œé¢ï¼Œè¿™é‡Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°å»æŠ“åŒ…ï¼ŒæŸ¥çœ‹æ˜¯å¦è¿”å›äº† 304, æ˜¯çš„è¯ï¼Œæˆ‘ä»¬å†è¯•è¯• ctrl+f5ã€‚

è¿™é‡Œç•Œé¢æ²¡æ›´æ–°ï¼Œæˆ‘ä»¬åšçš„ä¸¤ä»¶äº‹æƒ…çš„ä¾æ®å°±æ˜¯æµè§ˆå™¨çš„ç¼“å­˜æœºåˆ¶ã€‚ç¬¬ä¸€æ¬¡åˆ·æ–°ç•Œé¢ï¼Œå¯èƒ½å‘½ä¸­äº†æµè§ˆå™¨çš„å¼ºç¼“å­˜ï¼Œèµ„æºæ–‡ä»¶è¿˜æ˜¯æ‹¿çš„æœ¬åœ°çš„ç¼“å­˜ï¼Œæ ¹æœ¬æ²¡æœ‰å»è¯·æ±‚æµè§ˆå™¨èµ„æºã€‚æ‰€ä»¥æˆ‘ä»¬ f5 åˆ·æ–°ä¸€ä¸‹ï¼Œä¼å›¾è·³è¿‡å¼ºç¼“å­˜ã€‚è·³è¿‡å¼ºç¼“å­˜æœ‰æ—¶å€™ç•Œé¢è¿˜æ˜¯æ—§çš„ï¼Œå¯èƒ½å‘½ä¸­äº†åå•†ç¼“å­˜ï¼Œè¿”å› 304ï¼Œé‚£æˆ‘ä»¬å°±è¯•è¯•ç”¨ ctrl+f5 è·³è¿‡ä»–ï¼Œç›´æ¥æ‹¿æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚

ä»ä»¥ä¸Šä¾‹å­å¯çŸ¥ï¼Œæµè§ˆå™¨ç¼“å­˜ç­–ç•¥åˆ†ä¸ºï¼šå¼ºç¼“å­˜å’Œåå•†ç¼“å­˜ï¼Œå¼ºç¼“å­˜ä¼˜å…ˆçº§é«˜äºåå•†ç¼“å­˜ã€‚é‚£ä¹ˆæµè§ˆå™¨ä»€ä¹ˆæ—¶å€™ä¼šç¼“å­˜æœåŠ¡å™¨è¿”å›çš„èµ„æºå‘¢ï¼Ÿå½“æˆ‘ä»¬ä»åœ°å€æ è·³åˆ°ä¸€ä¸ª url æ—¶ï¼Œæµè§ˆå™¨ä¼šç¼“å­˜è¯·æ±‚è¿”å›çš„æ•°æ®å’Œç¼“å­˜ç›¸å…³æ ‡è¯†ï¼Œä¸‹æ¬¡è¯·æ±‚æ—¶ä¼šæ ¹æ®å¯¹åº”çš„è§„åˆ™é‡‡ç”¨å¯¹åº”çš„ç­–ç•¥æ‹¿æ•°æ®ã€‚

é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ç½‘é¡µæ–‡ä»¶è¦æ›´æ–°åˆ°éƒ¨ç½²çš„æœ€æ–°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦è·³è¿‡æµè§ˆå™¨ç¼“å­˜ï¼Œç›´æ¥ä»æœåŠ¡å™¨è¯·æ±‚èµ„æºï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š

**1ã€ä»£ç æ„å»ºæ—¶ï¼Œæ–‡ä»¶ååŠ å“ˆå¸Œå€¼**

**2ã€æœåŠ¡ç«¯é…ç½®é»˜è®¤ä¸å¼ºç¼“å­˜**

```nginx
# Nginx ç¤ºä¾‹ï¼šå¯¹ HTML æ–‡ä»¶ç¦ç”¨ç¼“å­˜
location / {
  if ($request_filename ~* .*\.(html|htm)$) {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires 0;
  }
}
```

å…³é”®å¤´å­—æ®µï¼š

- Cache-Control: no-cacheï¼šæ¯æ¬¡è¯·æ±‚éœ€å‘æœåŠ¡å™¨éªŒè¯èµ„æºæ˜¯å¦æœ€æ–°ï¼ˆé’ˆå¯¹ index.html è¿™ç§å…¥å£æ–‡ä»¶ï¼‰ã€‚
- Cache-Control: max-age=31536000, immutableï¼šå¯¹å¸¦å“ˆå¸Œçš„é™æ€èµ„æºï¼ˆå¦‚ JS/CSSï¼‰è®¾ç½®é•¿æœŸç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚

**3ã€ç½‘é¡µå¼ºåˆ¶åˆ·æ–°**

é€šè¿‡ç‰ˆæœ¬æ£€æµ‹ï¼Œè°ƒç”¨ location.reload å¼ºåˆ¶é¡µé¢åˆ·æ–°

## ä¸‰ã€åŸºäºè½®è¯¢çš„ç½‘é¡µæ›´æ–°å¼¹çª—å®ç°

### 1. é€»è¾‘æ¦‚è¿°

- ç‰ˆæœ¬æ£€æµ‹ï¼šé€šè¿‡å¯¹æ¯”å½“å‰ç‰ˆæœ¬å·å’Œæœ¬åœ° version.json æ–‡ä»¶ä¸­çš„æœ€æ–°ç‰ˆæœ¬å·ï¼Œæ£€æµ‹ç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°(åœ¨æ¯æ¬¡æ„å»ºæ—¶å‘ version.json å†™å…¥æœ€æ–°ç‰ˆæœ¬å·ï¼Œè¯·æ±‚çš„æ—¶å€™æ³¨æ„åœ¨ version.json åé¢åŠ ä¸Šæ–°çš„ query å€¼ï¼Œé¿å…è¯·æ±‚åˆ°ç¼“å­˜çš„æ–‡ä»¶)
- ç½‘é¡µæ›´æ–°ï¼šå½“ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ˜¾ç¤ºæ¨¡æ€å¼¹çª—ï¼Œæç¤ºç”¨æˆ·éœ€è¦åˆ·æ–°æ‰èƒ½ç”¨åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œè‹¥ç”¨æˆ·ç¡®å®šåˆ·æ–°ï¼Œåˆ·æ–°å¹¶å°†æœ€æ–°çš„ç‰ˆæœ¬å·ç¼“å­˜åˆ°æµè§ˆå™¨ä¸­ï¼Œå…³é—­å¼¹çª—ï¼Œå¦åˆ™å…³é—­å¼¹çª—

### 2. demo

- version.json

```json
{
  "version": "2.2.0"
}
```

- checkUpdate.js

```js
class UpdateChecker {
  constructor(options = {}) {
    this.options = {
      checkInterval: 1 * 60 * 1000, // 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      versionFile: '/version.json?t=',
      ...options
    };
    const version = this.getVersion();
    this.currentVersion = version || '0.0.0';
    this.setVersion(this.currentVersion);
    this.timer = null;
    this.init();
  }

  setVersion(version) {
    localStorage.setItem('version', version);
  }

  getVersion() {
    return localStorage.getItem('version');
  }

  async init() {
    // é¦–æ¬¡æ£€æŸ¥ç‰ˆæœ¬
    await this.checkVersion();
    // å®šæ—¶æ£€æŸ¥
    this.timer = setInterval(
      () => this.checkVersion(),
      this.options.checkInterval
    );
  }

  async checkVersion() {
    try {
      console.log(`Checking version: ${Date.now()}`);
      const res = await fetch(this.options.versionFile + Date.now());
      const data = await res.json();

      if (data.version !== this.currentVersion) {
        const dialog = document.querySelector('.update-dialog');
        if (dialog) return;
        this.showUpdateDialog(data.version);
      }
    } catch (error) {
      console.error('Version check failed:', error);
    }
  }

  showUpdateDialog(version) {
    const dialog = document.createElement('div');
    dialog.className = 'update-dialog';
    dialog.innerHTML = `
      <div class="dialog-content">
        <h3>å‘ç°æ–°ç‰ˆæœ¬ ğŸš€</h3>
        <p>è¯·åˆ·æ–°é¡µé¢è·å–æœ€æ–°åŠŸèƒ½</p>
        <div class="actions">
          <button class="refresh">ç«‹å³æ›´æ–°</button>
          <button class="later">ç¨åæé†’</button>
        </div>
      </div>
    `;

    dialog.querySelector('.refresh').addEventListener('click', () => {
      this.currentVersion = version;
      this.setVersion(this.currentVersion);
      clearInterval(this.timer);
      window.location.reload(true);
    });

    dialog.querySelector('.later').addEventListener('click', () => {
      document.body.removeChild(dialog);
    });

    document.body.appendChild(dialog);
  }
}

// åˆå§‹åŒ–æ£€æµ‹
new UpdateChecker();
```

- dialog.css

```css
.update-dialog {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.dialog-content {
  background: white;
  padding: 2rem;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.actions {
  margin-top: 1.5rem;
  display: flex;
  gap: 1rem;
  justify-content: center;
}

button.refresh {
  background: #1890ff;
  color: white;
  padding: 8px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button.later {
  background: #f5f5f5;
  padding: 8px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
```

å‚è€ƒæ–‡çŒ®ï¼š

[è¯´è¯´æµè§ˆå™¨ç¼“å­˜æœºåˆ¶](https://canace.site/%E8%AF%B4%E8%AF%B4%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/)
